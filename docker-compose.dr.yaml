# AST DR Site - Complete Stack
# 
# Components:
#   - VictoriaMetrics (metrics storage)
#   - ClickHouse (analytics storage)
#   - OTEL Collector (controlled by watcher - only active during failover)
#   - Grafana (dashboards)
#   - dns-failover (monitors primary, takes over if failed)
#   - otel-watcher (controls OTEL based on DNS)
#   - ch-sync (replicates ClickHouse from Primary)
#   - vm-sync (pulls from Primary to fill gaps)
#
# Usage:
#   docker compose -f docker-compose.dr.yaml up -d

volumes:
  victoriametrics:
  clickhouse:
  grafana:

networks:
  ast_network:
    driver: bridge

services:
  # ===================
  # METRICS STORAGE
  # ===================
  victoriametrics:
    image: victoriametrics/victoria-metrics:v1.93.0
    container_name: victoriametrics
    restart: unless-stopped
    stop_grace_period: 5m
    volumes:
      - victoriametrics:/victoria-metrics-data
    command:
      - '--storageDataPath=/victoria-metrics-data'
      - '--retentionPeriod=12'
      - '--httpListenAddr=:8428'
      - '--dedup.minScrapeInterval=30s'
    ports:
      - "8428:8428"
    networks:
      - ast_network

  # ===================
  # ANALYTICS STORAGE
  # ===================
  clickhouse:
    image: clickhouse/clickhouse-server:24.1
    container_name: clickhouse
    restart: unless-stopped
    volumes:
      - clickhouse:/var/lib/clickhouse
      - ./services/clickhouse/config.xml:/etc/clickhouse-server/config.d/custom.xml:ro
      - ./services/clickhouse/users.xml:/etc/clickhouse-server/users.d/custom.xml:ro
    ports:
      - "8123:8123"
      - "9000:9000"
    environment:
      - CLICKHOUSE_DB=ast
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=
    networks:
      - ast_network

  # ===================
  # TELEMETRY COLLECTOR
  # ===================
  otel-collector:
    image: ghcr.io/f5devcentral/application-study-tool/otel_custom_collector:v0.9.6
    container_name: application-study-tool-otel-collector-1
    restart: "no"
    volumes:
      - ./services/otel_collector:/etc/otel-collector-config
    command:
      - "--config=/etc/otel-collector-config/defaults/bigip-scraper-config.yaml"
    env_file:
      - ".env"
      - ".env.device-secrets"
    ports:
      - "8888:8888"
      - "4317:4317"
      - "4318:4318"
    networks:
      - ast_network
    depends_on:
      - victoriametrics
      - clickhouse

  # ===================
  # DASHBOARDS
  # ===================
  grafana:
    image: grafana/grafana:11.1.0
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - grafana:/var/lib/grafana
      - ./services/grafana/provisioning:/etc/grafana/provisioning
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_INSTALL_PLUGINS=grafana-clickhouse-datasource
    env_file:
      - ".env"
    networks:
      - ast_network
    depends_on:
      - victoriametrics
      - clickhouse

  # ===================
  # FAILOVER SYSTEM
  # ===================
  dns-failover:
    build:
      context: ./failover
      dockerfile: Dockerfile
    image: dns-failover
    container_name: dns-failover
    restart: unless-stopped
    env_file:
      - ./failover/.env.dr
    volumes:
      - ./failover/state:/state
    networks:
      - ast_network

  otel-watcher:
    build:
      context: ./failover
      dockerfile: Dockerfile.otel-watcher-docker
    image: otel-watcher
    container_name: otel-watcher
    restart: unless-stopped
    network_mode: host
    environment:
      - DNS_RECORD=failover.mpwlabs.com
      - MY_IP=192.168.100.143
      - OTEL_CONTAINER=application-study-tool-otel-collector-1
      - DNS_SERVER=8.8.8.8
      - OTEL_CHECK_INTERVAL=15
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - dns-failover

  # ===================
  # REPLICATION: VM Sync (pulls from Primary to fill gaps)
  # ===================
  vm-sync:
    build:
      context: ./vm-sync
      dockerfile: Dockerfile
    image: vm-sync
    container_name: vm-sync
    restart: unless-stopped
    environment:
      - SOURCE_URL=http://192.168.100.144:8428
      - DEST_URL=http://victoriametrics:8428
      - SYNC_INTERVAL=300
      - SYNC_LOOKBACK=30
    networks:
      - ast_network
    depends_on:
      - victoriametrics
